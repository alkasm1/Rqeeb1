<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Shape Matcher with OpenCV</title>
  <script async src="https://docs.opencv.org/4.5.2/opencv.js" type="text/javascript"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    canvas { border: 1px solid #aaa; margin-top: 15px; }
  </style>
</head>
<body>
  <h2>🔍 تحديد الشكلين الهندسيين الأكثر تشابهًا</h2>
  <input type="file" id="imgInput" accept="image/*">
  <canvas id="canvasOutput"></canvas>

  <script type="text/javascript">
    document.getElementById('imgInput').addEventListener('change', function (e) {
      let img = new Image();
      img.src = URL.createObjectURL(e.target.files[0]);
      img.onload = function () {
        let canvas = document.getElementById('canvasOutput');
        canvas.width = img.width;
        canvas.height = img.height;
        let ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        // تحويل الصورة إلى مصفوفة OpenCV
        let src = cv.imread(canvas);
        let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

        // اكتشاف الحواف
        let edges = new cv.Mat();
        cv.Canny(gray, edges, 50, 150);

        // استخراج الأشكال
        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        // مقارنة كل شكلين لاختيار الأكثر تشابهًا
        let bestScore = Infinity;
        let bestPair = [null, null];

        for (let i = 0; i < contours.size(); i++) {
          for (let j = i + 1; j < contours.size(); j++) {
            let score = cv.matchShapes(contours.get(i), contours.get(j), cv.CONTOURS_MATCH_I1, 0);
            if (score < bestScore) {
              bestScore = score;
              bestPair = [i, j];
            }
          }
        }

        // تمييز الشكلين الأكثر تطابقًا باللون الأحمر
        let color = new cv.Scalar(255, 0, 0, 255);
        cv.drawContours(src, contours, bestPair[0], color, 3);
        cv.drawContours(src, contours, bestPair[1], color, 3);

        cv.imshow('canvasOutput', src);

        // تنظيف الذاكرة
        src.delete(); gray.delete(); edges.delete(); contours.delete(); hierarchy.delete();
      }
    });
  </script>
</body>
</html>
