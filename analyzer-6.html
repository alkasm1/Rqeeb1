<!-- 🖼️ اختيار الصورة -->
<input type="file" id="imageUpload" accept="image/*" onchange="loadImage(event)">
<br>
<canvas id="imageCanvas"></canvas>
<br><br>

<!-- 🔘 أزرار التحكم -->
<button onclick="previewShapes()">👁️ معاينة الأشكال الهندسية</button>
<button onclick="analyzeImage()">🧠 تحليل الصورة</button>

<script type="text/javascript">
function loadImage(event) {
  let img = new Image();
  img.onload = function () {
    let canvas = document.getElementById('imageCanvas');
    let ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
  };
  img.src = URL.createObjectURL(event.target.files[0]);
}

function previewShapes() {
  let src = cv.imread('imageCanvas');
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let imageArea = src.cols * src.rows;
  let preview = src.clone();

  for (let i = 0; i < contours.size(); i++) {
    let cnt = contours.get(i);
    let area = cv.contourArea(cnt);

    if (area >= imageArea * 0.4) {
      let color = new cv.Scalar(255, 0, 0, 255); // لون أحمر
      cv.drawContours(preview, contours, i, color, 2, cv.LINE_8, hierarchy, 0);
    }
  }

  cv.imshow('imageCanvas', preview);
  gray.delete(); hierarchy.delete(); contours.delete(); preview.delete();
}

function analyzeImage() {
  let src = cv.imread('imageCanvas');
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let imageArea = src.cols * src.rows;
  let validShapes = [];

  for (let i = 0; i < contours.size(); i++) {
    let cnt = contours.get(i);
    let area = cv.contourArea(cnt);

    if (area >= imageArea * 0.4) {
      validShapes.push({ contour: cnt, area });
    }
  }

  if (validShapes.length < 2) {
    alert("⚠️ لم يتم العثور على شكلين يتجاوزان 40٪ من حجم الصورة!");
    return;
  }

  compareShapes(validShapes[0].contour, validShapes[1].contour);

  gray.delete(); hierarchy.delete(); contours.delete();
}
</script>
