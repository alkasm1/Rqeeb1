<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ÙƒØ´Ù Ø§Ù„ØªØ²ÙˆÙŠØ± Ø§Ù„Ø°ÙƒÙŠ</title>
  <style>
    body {
      background: #111;
      color: #ff8800;
      font-family: 'Cairo', sans-serif;
      text-align: center;
    }
    video, img {
      width: 100%;
      max-width: 500px;
      border: 2px solid #ff8800;
      margin: 1rem 0;
    }
    .box {
      position: absolute;
      width: 220px;
      height: 220px;
      border: 2px solid;
    }
    .left { top: 50px; left: 10px; border-color: #0f0; }
    .right { top: 50px; right: 10px; border-color: #f00; }
    button, input[type="file"] {
      margin: 0.5rem;
      padding: 0.6rem;
      font-size: 1rem;
      border-radius: 8px;
      background: #ff8800;
      color: white;
      border: none;
      cursor: pointer;
    }
    canvas { display: none; }
    #results {
      margin-top: 1rem;
      padding: 10px;
      font-size: 1rem;
      color: #eee;
      background: #222;
      border-radius: 8px;
      width: fit-content;
      margin-inline: auto;
    }
  </style>
</head>
<body>
  <h2>ğŸ” ÙƒØ´Ù Ø§Ù„ØªØ²ÙˆÙŠØ± Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h2>

  <video id="video" autoplay playsinline></video>
  <img id="uploadedImage" style="display:none;" />
  <input type="file" accept="image/*" onchange="handleUpload(event)">
  <button onclick="analyze()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
  <div id="results"></div>
  <canvas id="canvas"></canvas>

<script>
const video = document.getElementById("video");
const img = document.getElementById("uploadedImage");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream)
  .catch(() => alert("ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©"));

function handleUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    img.src = ev.target.result;
    img.style.display = "block";
    video.style.display = "none";
  };
  reader.readAsDataURL(file);
}

function analyze() {
  const source = video.style.display === "none" ? img : video;
  if (!source) return;

  const w = source.videoWidth || source.naturalWidth;
  const h = source.videoHeight || source.naturalHeight;
  canvas.width = w;
  canvas.height = h;
  ctx.drawImage(source, 0, 0, w, h);

  const boxW = 220, boxH = 220;
  const left = ctx.getImageData(10, 50, boxW, boxH);
  const right = ctx.getImageData(w - boxW - 10, 50, boxW, boxH);

  const shape = estimateShapeMatch(left, right);
  if (shape < 50)
    return document.getElementById("results").innerHTML = `ğŸ“ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ: ${shape.toFixed(1)}% âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©`;

  const color = compareHSV(left.data, right.data);
  const texture1 = analyzeTexture(left.data);
  const texture2 = analyzeTexture(right.data);
  const textureDiff = Math.abs(texture1.dev - texture2.dev);
  const texture = 100 - Math.min(textureDiff, 100);

  const edge1 = analyzeEdges(left.data, boxW, boxH);
  const edge2 = analyzeEdges(right.data, boxW, boxH);
  const edge = 100 - Math.abs(edge1 - edge2);

  const finalScore = ((color + texture + edge) / 3).toFixed(1);
  const decision = finalScore >= 85 ? "âœ… ØªØ·Ø§Ø¨Ù‚ Ø¹Ù„Ù…ÙŠ Ù…Ø¤ÙƒØ¯" : "âš ï¸ Ù…Ø­ØªÙ…Ù„ ØªØ²ÙˆÙŠØ±";

  document.getElementById("results").innerHTML = `
    ğŸ“ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ (ØªÙ… ØªØ¬Ø§ÙˆØ²Ù‡): ${shape.toFixed(1)}%<br>
    ğŸ¨ Ø§Ù„Ù„ÙˆÙ† (HSV): ${color.toFixed(1)}%<br>
    ğŸ§¶ Ø§Ù„Ù†Ø³ÙŠØ¬: ${texture.toFixed(1)}%<br>
    ğŸ§± Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¨ØµØ±ÙŠØ©: ${edge.toFixed(1)}%<br><br>
    ğŸ§  Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${finalScore}%<br>${decision}
  `;
}

// âœ… ØªØ­Ù„ÙŠÙ„ HSV
function compareHSV(data1, data2) {
  function rgbToHsv(r,g,b){
    r/=255; g/=255; b/=255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    const d = max - min;
    let h = 0, s = max === 0 ? 0 : d / max, v = max;
    if (d !== 0) {
      if (max === r) h = ((g - b) / d) + (g < b ? 6 : 0);
      else if (max === g) h = ((b - r) / d) + 2;
      else h = ((r - g) / d) + 4;
      h *= 60;
    }
    return [h, s * 100, v * 100];
  }

  let h1=0,s1=0,v1=0, h2=0,s2=0,v2=0;
  for (let i=0; i<data1.length; i+=4) {
    let [a,b,c] = rgbToHsv(data1[i],data1[i+1],data1[i+2]);
    h1+=a; s1+=b; v1+=c;
    [a,b,c] = rgbToHsv(data2[i],data2[i+1],data2[i+2]);
    h2+=a; s2+=b; v2+=c;
  }
  const total = data1.length / 4;
  const dh = Math.abs(h1/total - h2/total) / 360 * 40;
  const ds = Math.abs(s1/total - s2/total) / 100 * 30;
  const dv = Math.abs(v1/total - v2/total) / 100 * 30;
  return Math.max(0, 100 - (dh + ds + dv));
}

// âœ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ø³ÙŠØ¬
function analyzeTexture(data){
  let sum = 0, values = [];
  for(let i=0; i<data.length; i+=4){
    const g = (data[i]+data[i+1]+data[i+2])/3;
    values.push(g);
    sum += g;
  }
  const avg = sum / values.length;
  const dev = Math.sqrt(values.reduce((a,v) => a + (v - avg) ** 2, 0) / values.length);
  return { avg, dev };
}

// âœ… Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ
function estimateShapeMatch(img1, img2){
  let matched = 0, pixels = img1.data.length / 4;
  for(let i = 0; i < img1.data.length; i += 4){
    const g1 = (img1.data[i]+img1.data[i+1]+img1.data[i+2])/3;
    const g2 = (img2.data[i]+img2.data[i+1]+img2.data[i+2])/3;
    if(Math.abs(g1 - g2) < 30) matched++;
  }
  return matched / pixels * 100;
}

// âœ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ù (Sobel X + Y)
function analyzeEdges(data,w,h){
  const sobelX = [-1,0,1,-2,0,2,-1,0,1];
  const sobelY = [-1,-2,-1,0,0,0,1,2,1];
  function g(x,y){
    let i=(y*w+x)*4;
    return (data[i]+data[i+1]+data[i+2])/3;
  }
  let total=0;
  for(let y=1; y<h-1; y++){
    for(let x=1;x<w-1;x++){
      let gx=0, gy=0, idx=0;
      for(let ky=-1;ky<=1;ky++){
        for
