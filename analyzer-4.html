<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>التحقق البصري الذكي</title>
  <style>
    body {
      background: #0b0b0b;
      color: #ff8800;
      font-family: 'Cairo', sans-serif;
      text-align: center;
      padding: 1rem;
    }
    video, img {
      width: 48%;
      max-width: 240px;
      border: 2px solid #ff8800;
      margin: 0.5rem;
    }
    button, input[type="file"] {
      margin: 0.5rem;
      padding: 0.6rem;
      font-size: 1rem;
      border-radius: 8px;
      background: #ff8800;
      color: white;
      border: none;
      cursor: pointer;
    }
    #results {
      margin-top: 1rem;
      font-size: 1rem;
      background: #222;
      padding: 1rem;
      border-radius: 10px;
      width: fit-content;
      margin-inline: auto;
      color: #eee;
    }
    canvas { display: none; }
  </style>
</head>
<body>
  <h2>🧠 التحقق البصري الذكي</h2>

  <video id="video" autoplay playsinline></video>
  <br>
  <input type="file" accept="image/*" onchange="loadImage(event, 'source1')" />
  <input type="file" accept="image/*" onchange="loadImage(event, 'source2')" />
  <br>
  <img id="source1" style="display:none;" />
  <img id="source2" style="display:none;" />

  <button onclick="analyze()">🔍 تحليل الشكل والمحتوى</button>
  <canvas id="canvas"></canvas>
  <div id="results"></div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const source1 = document.getElementById("source1");
const source2 = document.getElementById("source2");
const video = document.getElementById("video");

// ✅ تشغيل الكاميرا بشكل آمن
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream)
  .catch(() => alert("🚫 لم يتم تشغيل الكاميرا"));

function loadImage(event, id) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = document.getElementById(id);
    img.src = e.target.result;
    img.style.display = "inline-block";
  };
  reader.readAsDataURL(file);
}

function analyze() {
  let input1 = source1.src ? source1 : video;
  let input2 = source2.src ? source2 : video;

  const w = input1.videoWidth || input1.naturalWidth;
  const h = input1.videoHeight || input1.naturalHeight;

  if (!w || !h) return alert("📷 المصدر غير جاهز بعد");

  canvas.width = w;
  canvas.height = h;
  ctx.drawImage(input1, 0, 0, w, h);
  const imgData1 = ctx.getImageData(10, 50, 220, 220);

  ctx.drawImage(input2, 0, 0, w, h);
  const imgData2 = ctx.getImageData(w - 230, 50, 220, 220);

  const shape = estimateShapeMatch(imgData1, imgData2);
  if (shape < 50) {
    document.getElementById("results").innerHTML = `📐 الشكل الهندسي: ${shape.toFixed(1)}% ❌ غير كافٍ للمقارنة`;
    return;
  }

  const color = compareHSV(imgData1.data, imgData2.data);
  const t1 = analyzeTexture(imgData1.data);
  const t2 = analyzeTexture(imgData2.data);
  const textureScore = 100 - Math.abs(t1.dev - t2.dev);
  const finalScore = ((color + textureScore) / 2).toFixed(1);
  const decision = finalScore >= 85 ? "✅ تطابق علمي مؤكد" : "⚠️ محتمل تزوير";

  document.getElementById("results").innerHTML = `
    📐 الشكل الهندسي (تم تجاوزه): ${shape.toFixed(1)}%<br>
    🎨 اللون: ${color.toFixed(1)}%<br>
    🧶 النسيج: ${textureScore.toFixed(1)}%<br><br>
    🧠 القرار النهائي: ${finalScore}%<br>${decision}
  `;
}

// ✅ تحليل اللون HSV
function compareHSV(d1, d2) {
  function rgbToHsv(r, g, b) {
    r /= 255; g /= 255; b /= 255;
    let max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h = 0, s = max === 0 ? 0 : (max - min) / max, v = max;
    if (max !== min) {
      if (max === r) h = ((g - b) / (max - min)) + (g < b ? 6 : 0);
      else if (max === g) h = ((b - r) / (max - min)) + 2;
      else h = ((r - g) / (max - min)) + 4;
      h *= 60;
    }
    return [h, s * 100, v * 100];
  }

  let h1 = 0, s1 = 0, v1 = 0;
  let h2 = 0, s2 = 0, v2 = 0;
  for (let i = 0; i < d1.length; i += 4) {
    const hsv1 = rgbToHsv(d1[i], d1[i+1], d1[i+2]);
    const hsv2 = rgbToHsv(d2[i], d2[i+1], d2[i+2]);
    h1 += hsv1[0]; s1 += hsv1[1]; v1 += hsv1[2];
    h2 += hsv2[0]; s2 += hsv2[1]; v2 += hsv2[2];
  }

  const total = d1.length / 4;
  const dh = Math.abs(h1/total - h2/total) / 360 * 40;
  const ds = Math.abs(s1/total - s2/total) / 100 * 30;
  const dv = Math.abs(v1/total - v2/total) / 100 * 30;
  return Math.max(0, 100 - (dh + ds + dv));
}

// ✅ تحليل النسيج
function analyzeTexture(data) {
  let sum = 0, vals = [];
  for (let i = 0; i < data.length; i += 4) {
    const g = (data[i] + data[i+1] + data[i+2]) / 3;
    vals.push(g); sum += g;
  }
  const avg = sum / vals.length;
  const dev = Math.sqrt(vals.reduce((a, v) => a + Math.pow(v - avg, 2), 0) / vals.length);
  return { avg, dev };
}

// ✅ مطابقة الشكل الهندسي
function estimateShapeMatch(i1, i2) {
  let matched = 0;
  const pixels = i1.data.length / 4;
  for (let i = 0; i < i1.data.length; i += 4) {
    const g1 = (i1.data[i] + i1.data[i+1] + i1.data[i+2]) / 3;
    const g2 = (i2.data[i] + i2.data[i+1] + i2.data[i+2]) / 3;
    if (Math.abs(g1 - g2) < 30) matched++;
  }
  return matched / pixels * 100;
}
</script>
</body>
</html>
