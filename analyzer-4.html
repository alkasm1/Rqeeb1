<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬</title>
  <style>
    body {
      background: #121212;
      color: #ff8800;
      font-family: 'Cairo', sans-serif;
      text-align: center;
      padding: 1rem;
    }
    video, img {
      width: 48%;
      max-width: 250px;
      border: 2px solid #ff8800;
      margin: 0.5rem;
    }
    button, input[type="file"] {
      margin: 0.5rem;
      padding: 0.6rem;
      font-size: 1rem;
      border-radius: 8px;
      background: #ff8800;
      color: white;
      border: none;
      cursor: pointer;
    }
    canvas { display: none; }
    #results {
      margin-top: 1rem;
      padding: 10px;
      font-size: 1rem;
      background: #222;
      border-radius: 8px;
      color: #eee;
      width: fit-content;
      margin-inline: auto;
    }
  </style>
</head>
<body>
  <h2>ğŸ§  Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h2>
  
  <video id="video" autoplay playsinline></video>
  <br>

  <input type="file" accept="image/*" onchange="loadOriginal(event)" />
  <input type="file" accept="image/*" onchange="loadTarget(event)" />
  <br>
  <img id="originalImg" style="display:none;" />
  <img id="targetImg" style="display:none;" />

  <button onclick="analyze()">ğŸ” ØªØ­Ù„ÙŠÙ„</button>
  <div id="results"></div>
  <canvas id="canvas"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const originalImg = document.getElementById("originalImg");
const targetImg = document.getElementById("targetImg");

navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream)
  .catch(() => alert("ğŸš« ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"));

function loadOriginal(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = ev => {
      originalImg.src = ev.target.result;
      originalImg.style.display = "inline-block";
    };
    reader.readAsDataURL(file);
  }
}

function loadTarget(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = ev => {
      targetImg.src = ev.target.result;
      targetImg.style.display = "inline-block";
    };
    reader.readAsDataURL(file);
  }
}

function analyze() {
  let source1, source2;

  if (originalImg.src && targetImg.src) {
    source1 = originalImg;
    source2 = targetImg;
  } else {
    source1 = video;
    source2 = video;
  }

  const w = source1.videoWidth || source1.naturalWidth;
  const h = source1.videoHeight || source1.naturalHeight;
  canvas.width = w;
  canvas.height = h;

  ctx.drawImage(source1, 0, 0, w, h);
  const imgData1 = ctx.getImageData(10, 50, 220, 220);

  ctx.drawImage(source2, 0, 0, w, h);
  const imgData2 = ctx.getImageData(w - 230, 50, 220, 220);

  const shape = estimateShapeMatch(imgData1, imgData2);
  const color = compareHSV(imgData1.data, imgData2.data);
  const texture1 = analyzeTexture(imgData1.data);
  const texture2 = analyzeTexture(imgData2.data);
  const textureDiff = Math.abs(texture1.dev - texture2.dev);
  const texture = 100 - Math.min(textureDiff, 100);
  const finalScore = ((color + texture) / 2).toFixed(1);
  const decision = finalScore >= 85 ? "âœ… ØªØ·Ø§Ø¨Ù‚ Ø¹Ù„Ù…ÙŠ Ù…Ø¤ÙƒØ¯" : "âš ï¸ Ù…Ø­ØªÙ…Ù„ ØªØ²ÙˆÙŠØ±";

  document.getElementById("results").innerHTML = `
    ğŸ“ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ: ${shape.toFixed(1)}%<br>
    ğŸ¨ Ø§Ù„Ù„ÙˆÙ† (HSV): ${color.toFixed(1)}%<br>
    ğŸ§¶ Ø§Ù„Ù†Ø³ÙŠØ¬: ${texture.toFixed(1)}%<br><br>
    ğŸ§  Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${finalScore}%<br>${decision}
  `;
}

function compareHSV(data1, data2) {
  function rgbToHsv(r,g,b){
    r/=255; g/=255; b/=255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    const d = max - min;
    let h = 0, s = max === 0 ? 0 : d / max, v = max;
    if (d !== 0) {
      if (max === r) h = ((g - b) / d) + (g < b ? 6 : 0);
      else if (max === g) h = ((b - r) / d) + 2;
      else h = ((r - g) / d) + 4;
      h *= 60;
    }
    return [h, s * 100, v * 100];
  }

  let h1=0,s1=0,v1=0, h2=0,s2=0,v2=0;
  for (let i=0; i<data1.length; i+=4) {
    let [a,b,c] = rgbToHsv(data1[i],data1[i+1],data1[i+2]);
    h1+=a; s1+=b; v1+=c;
    [a,b,c] = rgbToHsv(data2[i],data2[i+1],data2[i+2]);
    h2+=a; s2+=b; v2+=c;
  }
  const total = data1.length / 4;
  const dh = Math.abs(h1/total - h2/total) / 360 * 40;
  const ds = Math.abs(s1/total - s2/total) / 100 * 30;
  const dv = Math.abs(v1/total - v2/total) / 100 * 30;
  return Math.max(0, 100 - (dh + ds + dv));
}

function analyzeTexture(data){
  let sum = 0, values = [];
  for(let i=0; i<data.length; i+=4){
    const g = (data[i]+data[i+1]+data[i+2])/3;
    values.push(g);
    sum += g;
  }
  const avg = sum / values.length;
  const dev = Math.sqrt(values.reduce((a,v) => a + (v - avg) ** 2, 0) / values.length);
  return { avg, dev };
}

function estimateShapeMatch(img1, img2){
  let matched = 0, pixels = img1.data.length / 4;
  for(let i = 0; i < img1.data.length; i += 4){
    const g1 = (img1.data[i]+img1.data[i+1]+img1.data[i+2])/3;
    const g2 = (img2.data[i]+img2.data[i+1]+img2.data[i+2])/3;
    if(Math.abs(g1 - g2) < 30) matched++;
  }
  return matched / pixels * 100;
}
</script>
</body>
</html>
